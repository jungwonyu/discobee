(function(){"use strict";class Q extends Phaser.Scene{constructor(){super("Boot")}preload(){this.load.spritesheet("loading","assets/img/start/ice_spritesheet.png",{frameWidth:105,frameHeight:128}),this.load.image("logo","assets/img/start/icecandy_logo.png")}create(){const{width:e,height:t}=this.scale,s=this.add.rectangle(0,0,e,t,13234170).setOrigin(0,0),i=this.add.image(e/2,t/2,"logo").setAlpha(0).setScale(.7);i.setY(i.y+100),this.tweens.add({targets:i,alpha:1,y:"-=120",duration:150,ease:"ease-in-out",repeat:0,onComplete:()=>{this.tweens.add({targets:i,alpha:1,y:"+=20",duration:100,ease:"ease-in-out",repeat:0})}}),this.time.delayedCall(1200,()=>{this.tweens.add({targets:[i,s],alpha:0,duration:200,ease:"ease-in-out",repeat:0})}),this.time.delayedCall(1500,()=>this.scene.start("Preloader"))}}class U{constructor(){this.bgm=null,this.isOn=!0}init(e,t,s){this.bgm||(this.bgm=e.sound.add(t,{...s}))}play(){this.bgm.isPlaying||this.bgm.play()}toggle(){this.bgm&&(this.isOn?(this.bgm.pause(),this.isOn=!1):(this.bgm.isPaused?this.bgm.resume():this.bgm.play(),this.isOn=!0))}pause(){this.bgm?.isPlaying&&this.bgm.pause()}stop(){this.bgm.stop(),this.isOn=!1}resume(){this.bgm&&!this.bgm.isPlaying&&this.bgm.resume()}}const M=new U;class $ extends Phaser.Scene{constructor(){super("Preloader")}init(){this.cameras.main.setBackgroundColor(13234170);const e=9751772,t={width:500,height:30},s={x:this.scale.width/2-t.width/2,y:this.scale.height/2-t.height/2},i=t.height/2,a=8,n={width:t.width+a,height:t.height+a},o=i+a,r={x:s.x-a/2,y:s.y-a/2},h=this.add.graphics({fillStyle:{color:16777215},lineStyle:{width:3,color:e}});h.fillRoundedRect(r.x,r.y,n.width,n.height,o),h.strokeRoundedRect(r.x,r.y,n.width,n.height,o);const l=this.add.graphics({fillStyle:{color:e}});l.fillRoundedRect(s.x,s.y,t.height,t.height,i),this.anims.create({key:"loading",frames:this.anims.generateFrameNumbers("loading",{start:1,end:4}),frameRate:12,repeat:-1});const c=this.add.sprite(0,0,"loading").play("loading");c.setScale(.5),c.y=s.y+t.height/2-c.height/2+14,this.load.on("progress",d=>{const m=Math.max(t.height,t.width*d);l.clear(),l.fillRoundedRect(s.x,s.y,m,t.height,i),c.x=s.x+m-t.height/2})}preload(){this.load.audio("bgm_audio","./assets/mp3/bgm.mp3"),this.load.audio("click","./assets/mp3/click.mp3"),this.load.image("bgm_O","assets/img/start/bgm_O.png"),this.load.image("bgm_X","assets/img/start/bgm_X.png"),this.load.image("bg","assets/img/start/start_bg.png"),this.load.image("start_title","assets/img/start/start_title.png"),this.load.image("start_char","assets/img/start/start_char.png"),this.load.spritesheet("start_btn","assets/img/start/start_btn.png",{frameWidth:383.5,frameHeight:143}),this.load.spritesheet("how_btn","assets/img/start/howToPlay_btn.png",{frameWidth:141,frameHeight:122}),this.load.image("howToPlay","assets/img/start/howToPlay.png"),this.load.image("close_btn","assets/img/start/close_btn.png"),this.load.image("close_btn_h","assets/img/start/close_btn_h.png"),this.load.image("play_btn","assets/img/help/play_btn.png"),this.load.image("pause_btn","assets/img/help/pause_btn.png"),this.load.image("help_next_btn","assets/img/help/next_btn.png"),this.load.image("help_next_btn_h","assets/img/help/next_btn_h.png"),this.load.image("help_prev_btn","assets/img/help/prev_btn.png"),this.load.image("help_prev_btn_h","assets/img/help/prev_btn_h.png"),this.load.video("help-video-1","assets/img/video/semple.mp4"),this.load.video("help-video-2","assets/img/video/semple.mp4"),this.load.video("help-video-3","assets/img/video/semple.mp4"),this.load.video("help-video-4","assets/img/video/semple.mp4"),this.load.image("hexagon","assets/img/play/hexagon.png"),this.load.image("limit","assets/img/play/limit.png"),this.load.image("my_hexagon","assets/img/play/hexagon_h.png"),this.load.image("player","assets/img/play/player.png"),this.load.image("player_speed","assets/img/play/player_speed.png"),this.load.image("player_invincible","assets/img/play/player_invincible.png"),this.load.image("enemy","assets/img/play/enemy.png"),this.load.image("enemy_freeze","assets/img/play/enemy_freeze.png"),this.load.image("item_freeze","assets/img/play/freeze.png"),this.load.image("item_speed","assets/img/play/speed.png"),this.load.image("item_invincible","assets/img/play/invincible.png"),this.load.spritesheet("buster_effect","assets/img/play/buster_effect.png",{frameWidth:200,frameHeight:200}),this.load.spritesheet("shield_effect","assets/img/play/shield_effect.png",{frameWidth:200,frameHeight:200}),this.load.spritesheet("quiz_start","assets/img/play/quiz_start.png",{frameWidth:274,frameHeight:99}),this.load.image("bee_gameOver","assets/img/over/bee.png"),this.load.image("balloon_gameOver","assets/img/over/balloon.png"),this.load.image("text_box","assets/img/over/text_box.png"),this.load.spritesheet("return_btn","assets/img/over/return_btn.png",{frameWidth:361.5,frameHeight:134}),this.load.spritesheet("bee_incorrect","assets/img/quiz/bee_incorrect.png",{frameWidth:170,frameHeight:223}),this.load.image("medal_1","assets/img/quiz/medal_1.png"),this.load.spritesheet("medal_1_1","assets/img/quiz/medal_1_1.png",{frameWidth:505.5,frameHeight:591}),this.load.spritesheet("medal_1_2","assets/img/quiz/medal_1_2.png",{frameWidth:505.5,frameHeight:591}),this.load.spritesheet("medal_1_3","assets/img/quiz/medal_1_3.png",{frameWidth:505.5,frameHeight:591}),this.load.spritesheet("medal_1_4","assets/img/quiz/medal_1_4.png",{frameWidth:505.5,frameHeight:591}),this.load.spritesheet("medal_1_5","assets/img/quiz/medal_1_5.png",{frameWidth:505.5,frameHeight:591}),this.load.image("medal_2","assets/img/quiz/medal_2.png"),this.load.spritesheet("medal_2_1","assets/img/quiz/medal_2_1.png",{frameWidth:505.5,frameHeight:591}),this.load.spritesheet("medal_2_2","assets/img/quiz/medal_2_2.png",{frameWidth:505.5,frameHeight:591}),this.load.spritesheet("medal_2_3","assets/img/quiz/medal_2_3.png",{frameWidth:505.5,frameHeight:591}),this.load.spritesheet("medal_2_4","assets/img/quiz/medal_2_4.png",{frameWidth:505.5,frameHeight:591}),this.load.spritesheet("medal_2_5","assets/img/quiz/medal_2_5.png",{frameWidth:505.5,frameHeight:591}),this.load.image("medal_3","assets/img/quiz/medal_3.png"),this.load.spritesheet("medal_3_1","assets/img/quiz/medal_3_1.png",{frameWidth:505.5,frameHeight:591}),this.load.spritesheet("medal_3_2","assets/img/quiz/medal_3_2.png",{frameWidth:505.5,frameHeight:591}),this.load.spritesheet("medal_3_3","assets/img/quiz/medal_3_3.png",{frameWidth:505.5,frameHeight:591}),this.load.spritesheet("medal_3_4","assets/img/quiz/medal_3_4.png",{frameWidth:505.5,frameHeight:591}),this.load.spritesheet("medal_3_5","assets/img/quiz/medal_3_5.png",{frameWidth:505.5,frameHeight:591}),this.load.image("medal_4","assets/img/quiz/medal_4.png"),this.load.spritesheet("medal_4_1","assets/img/quiz/medal_4_1.png",{frameWidth:505.5,frameHeight:591}),this.load.spritesheet("medal_4_2","assets/img/quiz/medal_4_2.png",{frameWidth:505.5,frameHeight:591}),this.load.spritesheet("medal_4_3","assets/img/quiz/medal_4_3.png",{frameWidth:505.5,frameHeight:591}),this.load.spritesheet("medal_4_4","assets/img/quiz/medal_4_4.png",{frameWidth:505.5,frameHeight:591}),this.load.spritesheet("medal_4_5","assets/img/quiz/medal_4_5.png",{frameWidth:505.5,frameHeight:591}),this.load.image("main_btn","assets/img/quiz/mainPage_btn.png"),this.load.image("main_btn_h","assets/img/quiz/mainPage_btn_h.png"),this.load.image("next_btn","assets/img/quiz/next_btn.png"),this.load.image("next_btn_h","assets/img/quiz/next_btn_h.png"),this.load.image("exit_btn","assets/img/quiz/exit_btn.png"),this.load.image("exit_btn_h","assets/img/quiz/exit_btn_h.png"),this.load.audio("correct","assets/mp3/correct.mp3"),this.load.audio("incorrect","assets/mp3/incorrect.mp3"),this.load.image("medal_1","assets/img/quiz/medal_1.png"),this.load.image("medal_2","assets/img/quiz/medal_2.png"),this.load.image("medal_3","assets/img/quiz/medal_3.png"),this.load.image("medal_4","assets/img/quiz/medal_4.png"),this.load.image("reset_btn","assets/img/medal/reset_btn.png"),this.load.image("reset_btn_h","assets/img/medal/reset_btn_h.png"),this.load.image("home_btn","assets/img/medal/home_btn.png"),this.load.image("bee_medal","assets/img/medal/bee_medal.png")}create(){this.initBgm(),this.time.delayedCall(500,()=>{this.scene.start("StartScene")})}initBgm(){M.init(this,"bgm_audio",{loop:!0,volume:.05})}}const I=(p,e=0,t=.5)=>{const{width:s,height:i}=p.sys.game.config;return p.add.rectangle(0,0,s,i,e,t).setOrigin(0,0).setDepth(0)},C=(p,e,t)=>{const s=`${e}_h`,i=p.scene;!i.textures.exists(e)||!i.textures.exists(s)||(p.on("pointerover",()=>p.setTexture(s)),p.on("pointerout",()=>p.setTexture(e)))},H=p=>{p.on("pointerover",()=>p.setFrame(1)),p.on("pointerout",()=>p.setFrame(0))},R=p=>p<=5?1:p<=15?2:p<=30?3:4,w={TITLE:{x:640,y:220,scale:.6},CHAR:{x:600,y:450,scale:.6},START_BTN:{x:640,y:630,scale:.6667},HOW_BTN:{x:1180,y:100,scale:.6667}};class Z extends Phaser.Scene{constructor(){super("StartScene")}create(){this.initScene(),this.createBackground(),this.createUI(),this.createButtons()}initScene(){this.registry.set("myMedals",{1:0,2:0,3:0,4:0}),["PlayScene","QuizScene","GameOverScene","MedalScene"].forEach(e=>this.scene.stop(e))}createBackground(){const{width:e,height:t}=this.sys.game.config,s=this.add.image(0,0,"bg").setOrigin(0),i=Math.max(e/s.width,t/s.height);s.setScale(i).setScrollFactor(0)}createUI(){this.add.image(w.TITLE.x,w.TITLE.y,"start_title").setScale(w.TITLE.scale),this.add.image(w.CHAR.x,w.CHAR.y,"start_char").setScale(w.CHAR.scale)}createButtons(){this.createStartButton(),this.createHowToPlayButton()}createStartButton(){const e=this.add.sprite(w.START_BTN.x,w.START_BTN.y,"start_btn",0).setInteractive({useHandCursor:!0}).setScale(w.START_BTN.scale);e.on("pointerdown",()=>{this.sound.play("click"),this.cameras.main.fadeOut(200,255,255,255),this.cameras.main.once("camerafadeoutcomplete",()=>{this.scene.start("PlayScene",{showMedalOnStart:!0})})}),H(e)}createHowToPlayButton(){const e=this.add.sprite(w.HOW_BTN.x,w.HOW_BTN.y,"how_btn",0).setInteractive({useHandCursor:!0}).setScale(w.HOW_BTN.scale);e.on("pointerdown",()=>this.scene.launch("HelpScene")),H(e)}}const f={width:64,height:55},q={width:1280,height:720},G={col:62,row:53},b={width:(G.col-1)*(f.width*.75)+f.width,height:(G.row-1)*f.height+f.height},K=150,j=5,J=10,ee=10,te="0xff3366",se=30,ie=60,ae=100,ne=10,E="Cafe24Surround",P={OVERLAY:0,OVERLAY_ALPHA:.7,HELP_BG:16777215,VIDEO_BG:16777215,TEXT:"#000000",NAV_BG:8947848,DOT_INACTIVE:13421772,DOT_HOVER:11184810,DOT_ACTIVE:3355443},z={HELP_BOX:{width:900,height:600},CLOSE_BTN:{offsetX:420,offsetY:-280,scale:.8},VIDEO_BOX:{width:600,height:338,offsetY:-80,scale:.3},TEXT:{startY:140,spacing:40,fontSize:"22px"},NAV_BTN:{offsetX:350,radius:25,scale:.4,depth:{bg:99,btn:100}},INDICATOR:{offsetY:250,spacing:30,radius:{normal:6,active:8}}},W=[{videoId:"help-video-1",texts:["마우스를 움직이면 꿀벌이 따라와요.","꿀벌이 선을 그어 표시한 곳은 숨겨진 그림이 드러나요."]},{videoId:"help-video-2",texts:["도전하기 버튼을 눌러 그림의 정체를 맞추면 메달을 얻을 수 있어요.","그림의 정체를 맞추지 못하면 게임이 끝나요."]},{videoId:"help-video-3",texts:["말벌과 부딪히면 게임이 끝나요.","선에 말벌이나 꿀벌이 닿아도 게임이 끝나요."]},{videoId:"help-video-4",texts:["아이템을 먹으면 다양한 효과를 얻을 수 있어요."]}];class re extends Phaser.Scene{constructor(){super("HelpScene"),this.totalPages=W.length,this.currentPage=0,this.videoElements=[],this.pages=[],this.pageIndicators=[]}create(){this.initScene(),this.createUI(),this.createPages(),this.createNavigationButtons(),this.createPageIndicator(),this.showPage(0)}initScene(){const{width:e,height:t}=this.sys.game.config;this.centerX=e/2,this.centerY=t/2,this.cleanup(),this.videoElements=[],this.pages=[],this.pageIndicators=[],this.currentPage=0}createUI(){I(this,P.OVERLAY,P.OVERLAY_ALPHA).setInteractive(),this.add.rectangle(this.centerX,this.centerY,z.HELP_BOX.width,z.HELP_BOX.height,P.HELP_BG),this.createCloseButton()}createCloseButton(){const{offsetX:e,offsetY:t,scale:s}=z.CLOSE_BTN,i=this.add.image(this.centerX+e,this.centerY+t,"close_btn").setInteractive({useHandCursor:!0}).setScale(s);C(i,"close_btn"),i.on("pointerdown",()=>{this.videoElements.forEach(a=>a.isPlaying()&&a.stop()),this.scene.stop()})}createPages(){W.forEach((e,t)=>{const s=this.add.container(this.centerX,this.centerY),{width:i,height:a,offsetY:n,scale:o}=z.VIDEO_BOX,r=this.add.rectangle(0,n,i,a,P.VIDEO_BG),h=this.add.video(0,n,e.videoId).setOrigin(.5).setLoop(!0).setScale(o);this.videoElements.push(h),s.add([r,h]),e.texts.forEach((l,c)=>{const{startY:d,spacing:m,fontSize:g}=z.TEXT,u=this.add.text(0,d+c*m,l,{fontSize:g,fontFamily:E,color:P.TEXT,align:"center",wordWrap:{width:800}}).setOrigin(.5);s.add(u)}),s.setVisible(!1),this.pages[t]=s})}createNavigationButtons(){const{offsetX:e,radius:t,scale:s,depth:i}=z.NAV_BTN;[{x:-e,btn:"prevButton",bg:"prevBg",key:"help_prev_btn",action:()=>this.prevPage()},{x:e,btn:"nextButton",bg:"nextBg",key:"help_next_btn",action:()=>this.nextPage()}].forEach(({x:n,btn:o,bg:r,key:h,action:l})=>{this[r]=this.add.circle(this.centerX+n,this.centerY,t,P.NAV_BG).setDepth(i.bg),this[o]=this.add.image(this.centerX+n,this.centerY,h).setInteractive({useHandCursor:!0}).setDepth(i.btn).setScale(s),C(this[o],h),this[o].on("pointerdown",l)})}createPageIndicator(){this.pageIndicators=[];const{offsetY:e,spacing:t,radius:s}=z.INDICATOR,i=this.centerX-(this.totalPages-1)*t/2;for(let a=0;a<this.totalPages;a++){const n=this.add.circle(i+a*t,this.centerY+e,s.normal,P.DOT_INACTIVE).setInteractive({useHandCursor:!0});n.on("pointerdown",()=>this.showPage(a)),n.on("pointerover",()=>this.currentPage!==a&&n.setFillStyle(P.DOT_HOVER)),n.on("pointerout",()=>this.currentPage!==a&&n.setFillStyle(P.DOT_INACTIVE)),this.pageIndicators.push(n)}}showPage(e){this.pages.forEach(s=>{s.setVisible(!1),s.setAlpha(0)}),this.currentPage=e;const t=this.pages[e];t&&(t.setVisible(!0),this.tweens.add({targets:t,alpha:1,duration:300,ease:"Cubic.easeOut"})),this.updateNavigationButtons(e),this.updatePageIndicators(e),this.playVideo(e)}updateNavigationButtons(e){const t=e===0,s=e===this.totalPages-1;this.prevButton.setVisible(!t),this.prevBg.setVisible(!t),this.nextButton.setVisible(!s),this.nextBg.setVisible(!s)}updatePageIndicators(e){const{radius:t}=z.INDICATOR;this.pageIndicators.forEach((s,i)=>{const a=i===e;s.setFillStyle(a?P.DOT_ACTIVE:P.DOT_INACTIVE),s.setRadius(a?t.active:t.normal)})}playVideo(e){this.videoElements.forEach((t,s)=>{t.isPlaying()&&t.stop(),s===e&&(t.setCurrentTime(0),t.setVolume(0),t.play())})}prevPage(){this.currentPage>0&&this.showPage(this.currentPage-1)}nextPage(){this.currentPage<this.totalPages-1&&this.showPage(this.currentPage+1)}cleanup(){this.videoElements?.forEach(e=>e?.destroy()),this.pages?.forEach(e=>e?.destroy()),this.pageIndicators?.forEach(e=>e?.destroy()),this.prevButton?.destroy(),this.nextButton?.destroy(),this.prevBg?.destroy(),this.nextBg?.destroy()}}const oe=[{answer:"banana",quizImage:"assets/img/play/world/banana.png",fullImage:"assets/img/play/world/banana_full.png",options:["bread","banana","potato"]},{answer:"diamond",quizImage:"assets/img/play/world/diamond.png",fullImage:"assets/img/play/world/diamond_full.png",options:["ice","diamond","mountain"]},{answer:"duck",quizImage:"assets/img/play/world/duck.png",fullImage:"assets/img/play/world/duck_full.png",options:["duck","snake","rabbit"]},{answer:"fan",quizImage:"assets/img/play/world/fan.png",fullImage:"assets/img/play/world/fan_full.png",options:["fan","net","basket"]},{answer:"sandwich",quizImage:"assets/img/play/world/sandwich.png",fullImage:"assets/img/play/world/sandwich_full.png",options:["cake","cutlet","sandwich"]},{answer:"scissors",quizImage:"assets/img/play/world/scissors.png",fullImage:"assets/img/play/world/scissors_full.png",options:["clock","scissors","skate shoes"]},{answer:"umbrella",quizImage:"assets/img/play/world/umbrella.png",fullImage:"assets/img/play/world/umbrella_full.png",options:["glass","spider","umbrella"]},{answer:"pencil",quizImage:"assets/img/play/world/pencil.png",fullImage:"assets/img/play/world/pencil_full.png",options:["wood","cookie","pencil"]},{answer:"ant",quizImage:"assets/img/play/world/ant.png",fullImage:"assets/img/play/world/ant_full.png",options:["scorpion","ant","butterfly"]},{answer:"book",quizImage:"assets/img/play/world/book.png",fullImage:"assets/img/play/world/book_full.png",options:["sun","gold","book"]}];class he{constructor({scene:e,properties:t}){this.scene=e,this.hexagonList=[],this.hexagonMap=new Map,this.answer=t.answer,this.tileWidth=f.width*.75,this.tileHeight=f.height,this.radiusByWidth=b.width/this.tileWidth/2,this.radiusByHeight=b.height/this.tileHeight/2,this.mapRadius=Math.floor(Math.min(this.radiusByWidth,this.radiusByHeight))-1,this.init()}init(){this.initQuizBg(),this.createHexagon(),this.createHexMask(),this.createQuizMask()}createQuizMask(){if(this.quizMaskGraphics=this.scene.make.graphics({add:!1}),this.updateQuizMask(),this.quizBg){const e=new Phaser.Display.Masks.GeometryMask(this.scene,this.quizMaskGraphics);this.quizBg.setMask(e)}}updateQuizMask(){if(this.quizMaskGraphics){this.quizMaskGraphics.clear();for(const e of this.hexagonList){if(e.texture&&e.texture.key!=="my_hexagon")continue;const t=e.x,s=e.y,i=this.getHexPoints(t,s,f.width,f.height);this.quizMaskGraphics.fillStyle(16777215,1),this.quizMaskGraphics.beginPath(),this.quizMaskGraphics.moveTo(i[0],i[1]);for(let a=2;a<i.length;a+=2)this.quizMaskGraphics.lineTo(i[a],i[a+1]);this.quizMaskGraphics.closePath(),this.quizMaskGraphics.fillPath()}}}initQuizBg(){this.quizBg=this.scene.add.image(b.width/2,b.height/2,this.answer).setDepth(0).setVisible(!0),this.bgDim=this.scene.add.graphics(),this.bgDim.fillStyle(0,.45).fillRect(0,0,b.width,b.height).setDepth(-10)}createHexMask(){const e=this.scene.make.graphics({add:!1});this.hexagonList.forEach(s=>{const{x:i,y:a,texture:n}=s;if(n.key==="limit")return;const o=this.getHexPoints(i,a,f.width,f.height),r=new Phaser.Geom.Polygon(o);e.fillPoints(r.points,!0)});const t=new Phaser.Display.Masks.GeometryMask(this.scene,e);this.bgDim.setMask(t)}createHexagon(){const e=Math.ceil((b.width+f.width)/this.tileWidth),t=Math.ceil((b.height+f.height/2)/f.height),s={col:Math.floor(e/2),row:Math.floor(t/2)},i=this.offsetToCube(s.col,s.row),a=(e-1)*this.tileWidth+f.width,n=(t-1)*f.height+f.height,o=b.width/2-a/2,r=b.height/2-n/2-25;for(let h=-1;h<e;h++)for(let l=-1;l<t;l++){const c=this.offsetToCube(h,l),d=this.getCubeDistance(i,c);if(d>this.mapRadius+1)continue;const m=h%2!==0,g=h*this.tileWidth+f.width/2+o,u=l*f.height+(m?f.height/2:0)+f.height/2+r,y=d>this.mapRadius?"limit":"hexagon",x=this.scene.add.image(g,u,y).setOrigin(.5);y==="hexagon"&&x.setAlpha(1),x.col=h,x.row=l,this.hexagonList.push(x),this.hexagonMap.set(`${h},${l}`,x)}}createRandomStartTerritory(){const e=this.hexagonList.filter(s=>this.getAroundTiles(s.col).every(i=>{const a=this.hexagonMap.get(`${s.col+i[0]},${s.row+i[1]}`);return a&&a.texture.key!=="limit"})),t=Phaser.Utils.Array.GetRandom(e);return t?([t,...this.getAroundTiles(t.col).map(s=>this.hexagonMap.get(`${t.col+s[0]},${t.row+s[1]}`)).filter(Boolean)].forEach(s=>s.setTexture("my_hexagon")),this.updateQuizMask&&this.updateQuizMask(),t):null}getAroundTiles(e){return e%2!==0?[[0,-1],[0,1],[-1,0],[1,0],[-1,1],[1,1]]:[[0,-1],[0,1],[-1,-1],[1,-1],[-1,0],[1,0]]}offsetToCube(e,t){const s=e,i=t-(e-(e&1))/2,a=-s-i;return{x:s,y:a,z:i}}getCubeDistance(e,t){return(Math.abs(e.x-t.x)+Math.abs(e.y-t.y)+Math.abs(e.z-t.z))/2}getHexPoints(e,t,s,i){return[e-s/2,t,e-s/4,t-i/2,e+s/4,t-i/2,e+s/2,t,e+s/4,t+i/2,e-s/4,t+i/2]}}class L{static getFittedSize(e,t,s,i){const a=e/t;let n=s,o=n/a;return o>i&&(o=i,n=o*a),{w:n,h:o}}constructor(e){this.scene=e,this.minimapCam=null,this.quizButton=null,this.medalIcon=null,this.createMinimap()}createMinimap(){const e=this.scene,t=10,s=250,i=250,a=e.world.w,n=e.world.h,{w:o,h:r}=L.getFittedSize(a,n,s,i),h=e.scale.width-o-t,l=t,c=o/a;if(this.minimapCam=e.cameras.add(h,l,o,r).setBounds(0,0,a,n).setZoom(c).setName("minimap"),this.createQuizButtonAndMedal({vx:h,vy:l,miniW:o,miniH:r}),e.hexagonList&&Array.isArray(e.hexagonList)){const d=e.hexagonList.filter(m=>m.texture&&m.texture.key==="hexagon");this.minimapCam.ignore([...d,this.quizButton,this.medalIcon])}e.medalIcon=this.medalIcon}createQuizButtonAndMedal({vx:e,vy:t,miniW:s,miniH:i}){const h=this.scene,l=e+s/2,c=t+i+50;this.quizButton=h.add.image(l,c,"quiz_start").setScale(.6667).setScrollFactor(0).setDepth(9999).setInteractive({useHandCursor:!0}),H(this.quizButton),this.quizButton.on("pointerdown",this.snapshot,this);const m=`medal_${R(this.hexagonPercent())}`,g=l+this.quizButton.displayWidth/2+-220,u=c;this.medalIcon=h.add.image(g,u,m).setScale(.7).setScrollFactor(0).setDepth(9999)}snapshot(){const e=this.scene,t=e.cameras.main;e.scene.pause(),document.querySelector("canvas").style.opacity="0";const s=e.itemManager?.items||e.items,i=e.activeEffects||[],a=[e.player,e.enemies,this.minimapCam,this.quizButton,s,e.trailGraphics,...i],n=e.stage.hexagonList.filter(g=>g.visible!==!1&&g.texture&&g.texture.key!=="limit"),o=[e.stage.bgDim];[...a,...n,...o].forEach(g=>g&&g.setVisible(!1));let r=e.stage&&e.stage.quizBg,h=null;r&&r.mask&&(h=r.mask,r.setMask(null));const l=t.zoom,c=e.canvasSize.w/e.world.w,d=e.canvasSize.h/e.world.h,m=Math.min(c,d);t.stopFollow().setZoom(m).setScroll(0,0),e.game.renderer.snapshot(g=>{r&&h&&r.setMask(h),setTimeout(()=>{e.game.renderer.snapshot(u=>{[...a,...n,...o].forEach(y=>y&&y.setVisible(!0)),t.setZoom(l).startFollow(e.player),e.textures.exists("worldSnapshot")&&e.textures.remove("worldSnapshot"),e.textures.exists("worldSnapshotNoHexagon")&&e.textures.remove("worldSnapshotNoHexagon"),e.textures.addImage("worldSnapshot",u),e.textures.addImage("worldSnapshotNoHexagon",g),e.scene.launch("QuizScene",{quiz:e.quiz,allQuizzes:e.allQuizzes,canvasSize:e.canvasSize,medalNumber:R(this.hexagonPercent())})})},0)})}hexagonPercent(){const e=this.scene.hexagonList,t=e.filter(i=>i.texture.key!=="limit").length,s=e.filter(i=>i.texture.key==="my_hexagon").length;return t===0?0:Math.floor(s/t*100)}updateMedal(){if(this.medalIcon){const t=`medal_${R(this.hexagonPercent())}`;this.medalIcon.setTexture(t)}}}const le=60,ce=200,de=50,F=12,ge=200,me=200,pe=[160,260],ue=[120,220];function S(p,e,t){const s=p.getNearestHexagon(e,t);return!s||s.texture.key==="limit"||p.isOnMyHexagon(e,t)?!1:!p.hexagonList.filter(a=>Phaser.Math.Distance.Between(a.x,a.y,s.x,s.y)<le&&a!==s).some(a=>a.texture?.key==="limit")}class fe{constructor(e){this.scene=e,this.config={enemyGroup:e.enemies,enemyRadius:e.enemyRadius,enemyRange:e.enemyRange,enemySpeed:e.enemySpeed,canvasSize:e.canvasSize,world:e.world,player:()=>e.player,hexagonList:e.hexagonList},this.bounds={minX:e.canvasSize.w/2,minY:e.canvasSize.h/2,maxX:e.world.w,maxY:e.world.h}}pickPattern(){return Phaser.Math.RND.pick(["LR","APPROACH","UD","APPROACH","CIRCLE","RECT","APPROACH"])}spawnEnemySimple(e=this.pickPattern()){const t=this.config,s=this.bounds;if(!t.enemyGroup)return;let i,a,n=0,o=!1;for(;!o&&n<de;){i=Phaser.Math.Between(s.minX,s.maxX),a=Phaser.Math.Between(s.minY,s.maxY);const r=Phaser.Math.Distance.Between(i,a,t.player().x,t.player().y);S(this.scene,i,a)&&r>ce&&(o=!0),n++}if(o){const r=t.enemyGroup.create(i,a,"enemy");return r.setSize(t.enemyRadius*2,t.enemyRadius*2),r.setScale(.7),r.setDepth(1),this.startPattern(r,e),r}return null}startPattern(e,t){const s=this.bounds;if(!(!e||!e.active||e.pendingRemoval))switch(t){case"LR":return this.startLR(e,s.minX,s.maxX);case"UD":return this.startUD(e,s.minY,s.maxY);case"CIRCLE":return this.startCircle(e,s.minX,s.maxX,s.minY,s.maxY);case"APPROACH":return this.startApproach(e,s.minX,s.maxX,s.minY,s.maxY);default:return this.startRect(e,s.minX,s.maxX,s.minY,s.maxY)}}nextPattern(e){!e||!e.active||e.pendingRemoval||this.startPattern(e,this.pickPattern())}go(e,t,s){const i=this.config;if(!e||!e.active||e.pendingRemoval)return;const a=Phaser.Math.Distance.Between(e.x,e.y,t.x,t.y),n=Math.max(50,a/(i.enemySpeed||90)*1e3);this.scene.tweens.killTweensOf(e),this.scene.tweens.add({targets:e,x:t.x,y:t.y,duration:n,ease:"Linear",onComplete:s})}chain(e,t,s){let i=0;const a=()=>{if(!e||!e.active||e.pendingRemoval)return;if(i>=t.length){s&&s();return}const n=t[i++];this.go(e,n,a)};a()}startLR(e,t,s){const i=this.config,a=Math.floor((i.enemyRange||ge)/2),n=Phaser.Math.Clamp(e.x-a,t,s),o=Phaser.Math.Clamp(e.x+a,t,s),r=[];if(S(this.scene,n,e.y)&&r.push({x:n,y:e.y}),S(this.scene,o,e.y)&&r.push({x:o,y:e.y}),r.length<2)return this.nextPattern(e);const l=Math.abs(e.x-n)<=Math.abs(e.x-o)?r:r.slice().reverse();this.chain(e,l,()=>this.nextPattern(e))}startUD(e,t,s){const i=this.config,a=Math.floor((i.enemyRange||me)/2),n=Phaser.Math.Clamp(e.y-a,t,s),o=Phaser.Math.Clamp(e.y+a,t,s),r=[];if(S(this.scene,e.x,n)&&r.push({x:e.x,y:n}),S(this.scene,e.x,o)&&r.push({x:e.x,y:o}),r.length<2)return this.nextPattern(e);const l=Math.abs(e.y-n)<=Math.abs(e.y-o)?r:r.slice().reverse();this.chain(e,l,()=>this.nextPattern(e))}startCircle(e,t,s,i,a){const n=Phaser.Math.Between(80,140),o=Math.min(e.x-t,s-e.x,e.y-i,a-e.y),r=Math.max(20,Math.min(n,o)),h=e.x,l=e.y,c=[];for(let d=1;d<=F;d++){const m=2*Math.PI*d/F,g=h+r*Math.cos(m),u=l+r*Math.sin(m);S(this.scene,g,u)&&c.push({x:g,y:u})}if(c.length<3)return this.nextPattern(e);this.chain(e,c,()=>this.nextPattern(e))}startRect(e,t,s,i,a){this.config;const n=Math.floor(Phaser.Math.Between(...pe)/2),o=Math.floor(Phaser.Math.Between(...ue)/2),r=Phaser.Math.Clamp(e.x-n,t,s),h=Phaser.Math.Clamp(e.x+n,t,s),l=Phaser.Math.Clamp(e.y-o,i,a),c=Phaser.Math.Clamp(e.y+o,i,a),d=[];if(S(this.scene,r,l)&&d.push({x:r,y:l}),S(this.scene,h,l)&&d.push({x:h,y:l}),S(this.scene,h,c)&&d.push({x:h,y:c}),S(this.scene,r,c)&&d.push({x:r,y:c}),d.length<3)return this.nextPattern(e);this.chain(e,d,()=>this.nextPattern(e))}startApproach(e,t,s,i,a){const n=this.config;if(!e||!e.active||e.pendingRemoval)return;const o=n.player();if(!o)return this.nextPattern(e);const r=o.x-e.x,h=o.y-e.y,l=Math.hypot(r,h);if(l<1)return this.nextPattern(e);const c=Math.min(n.enemyRange||100,l),d=r/l,m=h/l;let g=e.x+d*c,u=e.y+m*c;g=Phaser.Math.Clamp(g,t,s),u=Phaser.Math.Clamp(u,i,a),this.go(e,{x:g,y:u},()=>this.nextPattern(e))}}class ye{constructor(e){this.scene=e,this.items=e.physics.add.group(),this.activeTimers=[],this.itemTypes=["freeze","speed","invincible"]}start(){this.itemTimer=this.scene.time.addEvent({delay:7e3,callback:()=>this.spawnItem(),callbackScope:this,loop:!0}),this.activeTimers.push(this.itemTimer)}shutdown(){this.activeTimers.forEach(e=>e&&e.remove()),this.activeTimers=[],this.items.getChildren().forEach(e=>e&&e.destroy())}spawnItem(){const e=this.scene,t=Phaser.Math.RND.pick(this.itemTypes),s=this.items.getChildren?this.items.getChildren():[],i=e.hexagonList;let a=null;for(let o=0;o<30;o++){const r=Phaser.Math.RND.pick(i);if(r.texture?.key==="limit"||e.isOnMyHexagon(r.x,r.y))continue;if(!s.some(l=>{const c=(l.x??0)-r.x,d=(l.y??0)-(r.y-10);return Math.sqrt(c*c+d*d)<30})){a=r;break}}if(!a)return;const n=this.items.create(a.x,a.y-10,`item_${t}`);n.setScale(.53),n.itemType=t,e.time.delayedCall(3e4,()=>{n.active&&n.destroy()},[],this)}eatItem(e,t){this.applyItemEffect(t),t.destroy()}applyItemEffect(e){switch(e.itemType){case"freeze":this.freezeEnemies(1e4);break;case"speed":this.boostPlayerSpeed(1e4,100);break;case"invincible":this.makePlayerInvincible(1e4);break}}freezeEnemies(e){const t=this.scene;if(t.enemyFrozen){t.time.delayedCall(e,()=>this.unfreezeEnemies(),[],this);return}t.enemyFrozen=!0,t.spawnTimer&&(t.spawnTimer.paused=!0);const s=t.enemies.getChildren();for(const i of s)t.tweens.killTweensOf(i),i.setVelocity(0),i.setTexture("enemy_freeze"),t.frozenEnemies.add(i);t.time.delayedCall(e,()=>this.unfreezeEnemies(),[],this)}unfreezeEnemies(){this.scene.enemyFrozen=!1;for(const e of this.scene.frozenEnemies)e&&e.active&&(e.setTexture("enemy"),this.scene.enemyManager.startPattern(e,this.scene.enemyManager.pickPattern()));this.scene.frozenEnemies.clear(),this.scene.time.delayedCall(0,()=>this.scene.cullEnemiesOnMyHex()),this.scene.spawnTimer&&(this.scene.spawnTimer.paused=!1)}boostPlayerSpeed(e,t){const s=this.scene;if(s.speedBoostTimer){const i=s.speedBoostTimer.getRemaining();s.speedBoostTimer.remove(),e+=i}s.speedBoostTimer&&s.speedBoostTimer.remove(),s.playerSpeed=s.originalPlayerSpeed+t,s.anims.exists("speed_effect")||s.anims.create({key:"speed_effect",frames:s.anims.generateFrameNumbers("buster_effect",{start:0,end:41}),frameRate:15,repeat:-1}),s.speedEffect||(s.speedEffect=s.add.sprite(s.player.x,s.player.y,"buster_effect"),s.speedEffect.setDepth(s.player.depth-1),s.activeEffects.push(s.speedEffect)),s.speedEffect.setVisible(!0),s.speedEffect.play("speed_effect",!0),s.speedBoostTimer=s.time.delayedCall(e,()=>{s.playerSpeed=s.originalPlayerSpeed,s.player.setTexture("player"),s.speedEffect&&s.speedEffect.setVisible(!1)},[],s),s.activeTimers.push(s.speedBoostTimer)}makePlayerInvincible(e){const t=this.scene;t.shieldEffectTimer&&t.shieldEffectTimer.remove(),t.isInvincible=!0,t.anims.exists("shield_effect")||t.anims.create({key:"shield_effect",frames:t.anims.generateFrameNumbers("shield_effect",{start:0,end:33}),frameRate:20,repeat:-1}),t.shieldEffect||(t.shieldEffect=t.add.sprite(t.player.x,t.player.y,"shield_effect"),t.shieldEffect.setDepth(2),t.activeEffects.push(t.shieldEffect)),t.shieldEffect.setVisible(!0),t.shieldEffect.play("shield_effect",!0),t.shieldEffectTimer=t.time.delayedCall(e,()=>{t.isInvincible=!1,t.player.setTexture("player"),t.shieldEffect&&t.shieldEffect.setVisible(!1)},[],t),t.activeTimers.push(t.shieldEffectTimer)}}class xe extends Phaser.Scene{constructor(){super("PlayScene"),this.quizData=oe}init(e={}){this.allQuizzes=e.allQuizzes||this.quizData,this.quiz=e.quiz||Phaser.Utils.Array.GetRandom(this.allQuizzes),this.showMedalOnStart=e.showMedalOnStart||!1,this.initGameState()}preload(){this.load.image(this.quiz.answer,this.quiz.quizImage)}create(){this.cameras.main.setBackgroundColor("#FBE68D"),this.initStage(),this.trailGraphics=this.add.graphics().setDepth(0),this.trailPath=[],this.player=this.physics.add.sprite(this.playerStartTile.x,this.playerStartTile.y,"player"),this.player.setCollideWorldBounds(!0),this.player.setDepth(1),this.physics.world.setBounds(0,0,this.world.w,this.world.h),this.cameras.main.setBounds(0,0,this.world.w,this.world.h),this.cameras.main.startFollow(this.player),this.dir=new Phaser.Math.Vector2(1,0),this.player.setVelocity(this.dir.x*this.playerSpeed,this.dir.y*this.playerSpeed),this.enemies=this.physics.add.group({collideWorldBounds:!0}),this.enemyManager=new fe(this),this.activeTimers=[],this.activeEffects=[];for(let e=0;e<this.enemyCount;e++)this.enemyManager.spawnEnemySimple();this.spawnTimer=this.time.addEvent({delay:3e3,callback:()=>this.enemyManager.spawnEnemySimple(),callbackScope:this,loop:!0}),this.activeTimers.push(this.spawnTimer),this.itemManager=new ye(this),this.itemManager.start(),this.miniMap=new L(this),this.physics.add.overlap(this.player,this.enemies,()=>!this.isInvincible&&this.gameOver("hit_enemy")),this.physics.add.overlap(this.player,this.itemManager.items,(e,t)=>this.itemManager.eatItem(e,t),null,this),this.showMedalOnStart&&(this.scene.pause(),this.scene.launch("MedalScene",{remainingQuizzes:this.allQuizzes}))}update(){if(this.playerMoving(),this.updateTrailPath(),this.activeEffects.forEach(e=>{e&&e.visible&&(e.x=this.player.x,e.y=this.player.y)}),!this.isInvincible&&this.checkSelfTrailCollision(this.player)){this.gameOver("hit_trail");return}!this.isInvincible&&this.checkEnemiesHitTrail()||(this.cullEnemiesOnMyHex(),this.miniMap&&this.miniMap.updateMedal())}initStage(){this.stage=new he({scene:this,properties:{answer:this.quiz.answer}}),this.playerStartTile=this.stage.createRandomStartTerritory(),this.hexagonList=this.stage.hexagonList}drawHexBorder(e,t,s=16724838,i=4){const a=this.hexagonSize.w,n=this.hexagonSize.h,o=a/2,r=n/2,h=[{x:e-o,y:t},{x:e-o/2,y:t-r},{x:e+o/2,y:t-r},{x:e+o,y:t},{x:e+o/2,y:t+r},{x:e-o/2,y:t+r},{x:e-o,y:t}];this.trailGraphics.lineStyle(i,s,1),this.trailGraphics.beginPath(),this.trailGraphics.moveTo(h[0].x,h[0].y);for(let l=1;l<h.length;l++)this.trailGraphics.lineTo(h[l].x,h[l].y);this.trailGraphics.strokePath()}initGameState(){this.isGameOver=!1,this.world={w:b.width,h:b.height},this.canvasSize={w:q.width,h:q.height},this.hexagonSize={w:f.width,h:f.height},this.hexagonList=[],this.playerSpeed=K,this.turnEase=j,this.isDrawing=!1,this.interval=J,this.trailWidth=ee,this.trailColor=te,this.isInvincible=!1,this.invincibilityTimer=null,this.originalPlayerSpeed=this.playerSpeed,this.speedBoostTimer=null,this.enemies=null,this.enemyCount=se,this.enemySpeed=ie,this.enemyRange=ae,this.enemyRadius=ne,this.enemyFrozen=!1,this.frozenEnemies=new Set,this.freezeTimer=null,this.items=null,this.speedEffect=null,this.shieldEffect=null,this.activeEffects=[]}shutdown(){this.activeTimers&&(this.activeTimers.forEach(e=>e&&e.remove()),this.activeTimers=[]),this.activeEffects&&(this.activeEffects.forEach(e=>e&&e.destroy()),this.activeEffects=[])}findInnerHoles(e=!0){if(!Array.isArray(this.hexagonList)||!this.hexagonList.length)return[];const t=(h,l)=>`${h},${l}`,s=new Map;for(const h of this.hexagonList)!h||h.col==null||h.row==null||s.set(t(h.col,h.row),h);const i=(h,l,c)=>s.get(t(h.col+l,h.row+c))||null,a=h=>h%2===0?[[0,-1],[0,1],[-1,-1],[1,-1],[-1,0],[1,0]]:[[0,-1],[0,1],[-1,0],[1,0],[-1,1],[1,1]],n=h=>!!h&&h.texture?.key!=="my_hexagon"&&h.texture?.key!=="limit",o=new Set,r=[];for(const h of this.hexagonList){if(!n(h))continue;const l=t(h.col,h.row);if(o.has(l))continue;const c=[],d=[h];o.add(l);let m=!1;for(;d.length;){const g=d.shift();c.push(g);for(const[u,y]of a(g.col)){const x=i(g,u,y);if(!x){m=!0;continue}if(x.texture?.key==="limit"){m=!0;continue}if(n(x)){const O=t(x.col,x.row);o.has(O)||(o.add(O),d.push(x))}}}m||(e&&c.forEach(g=>this.markAsMyHexagon(g)),r.push(c))}return r}playerMoving(){if(!this.player||!this.player.body)return;const e=this.input.activePointer,t=this.cameras.main.getWorldPoint(e.x,e.y),s=t.x-this.player.x,i=t.y-this.player.y;if(this.isLockedOnWall){const g=new Phaser.Math.Vector2(this.player.x-this.lastCollidingHex.x,this.player.y-this.lastCollidingHex.y).normalize();new Phaser.Math.Vector2(s,i).normalize().dot(g)>.5&&(this.isLockedOnWall=!1)}const a=new Phaser.Math.Vector2(s,i);if(a.length()<1){this.player.setVelocity(0,0);return}if(a.normalize(),!this.isLockedOnWall){const g=this.game.loop.delta/1e3,u=1-Math.exp(-this.turnEase*g);this.dir.lerp(a,u)}this.dir.normalize();const n=this.dir,o=this.playerSpeed*(this.game.loop.delta/1e3),r=this.player.x+n.x*o,h=this.player.y+n.y*o;let l=!1,c=null;const d=20,m=[{x:r,y:h},{x:r+n.x*d,y:h+n.y*d},{x:r+n.y*d,y:h-n.x*d},{x:r-n.y*d,y:h+n.x*d}];for(const g of m){const u=this.getNearestHexagon(g.x,g.y);if(u&&u.texture.key==="limit"){l=!0,c=u;break}}if(!l)this.player.setVelocity(n.x*this.playerSpeed,n.y*this.playerSpeed),this.player.setAngle(Phaser.Math.RadToDeg(Math.atan2(n.y,n.x)));else{this.isLockedOnWall=!0,this.lastCollidingHex=c;const g=new Phaser.Math.Vector2(this.player.x-c.x,this.player.y-c.y),u=this.hexagonSize.w/2+d;g.setLength(u),this.player.setPosition(c.x+g.x,c.y+g.y);const y=new Phaser.Math.Vector2(this.player.x-c.x,this.player.y-c.y).normalize(),x=new Phaser.Math.Vector2(y.y,-y.x),O=new Phaser.Math.Vector2(-y.y,y.x),ze=n.dot(x),Me=n.dot(O),k=ze>Me?x:O;this.player.setVelocity(k.x*this.playerSpeed,k.y*this.playerSpeed),this.dir.set(k.x,k.y),this.player.setAngle(Phaser.Math.RadToDeg(Math.atan2(k.y,k.x)))}}updateTrailPath(){const e=this.player.x,t=this.player.y,s=this.isOnMyHexagon(e,t);if(!s&&!this.isDrawing?this.startTrail(e,t):!s&&this.isDrawing?this.updateTrail(e,t):s&&this.isDrawing&&this.finishTrail(),this.checkSelfTrailCollision(this.player)){this.gameOver("hit_trail");return}}checkSelfTrailCollision(e,t=6,s=this.trailWidth){const i=this.trailPath.length;if(i<3)return!1;const a=i-1-t;if(a<=0)return!1;const n=s,o=n*n;for(let r=0;r<a;r++){const h=this.trailPath[r],l=this.trailPath[r+1],c=this.pointToSegmentDistance(e.x,e.y,h.x,h.y,l.x,l.y);if(c*c<=o)return!0}return!1}pointToSegmentDistance(e,t,s,i,a,n){const o=this.squaredDistance(s,i,a,n);if(o===0)return Math.sqrt(this.squaredDistance(e,t,s,i));const r=this.clampToUnit(((e-s)*(a-s)+(t-i)*(n-i))/o),h=s+r*(a-s),l=i+r*(n-i);return Math.sqrt(this.squaredDistance(e,t,h,l))}squaredDistance(e,t,s,i){const a=e-s,n=t-i;return a*a+n*n}clampToUnit(e){return e<0?0:e>1?1:e}isOnMyHexagon(e,t){const s=this.getNearestHexagon(e,t);if(!s||s.texture?.key!=="my_hexagon")return!1;const i=s.displayWidth||this.hexagonSize.w,a=s.displayHeight||this.hexagonSize.h;return this.pointInFlatTopHex(e,t,s.x,s.y,i,a,1)}pointInFlatTopHex(e,t,s,i,a,n,o=1){const r=a*o/2,h=n*o/2,l=[s-r,i,s-r/2,i-h,s+r/2,i-h,s+r,i,s+r/2,i+h,s-r/2,i+h],c=new Phaser.Geom.Polygon(l);return Phaser.Geom.Polygon.Contains(c,e,t)}startTrail(e,t){this.isDrawing=!0,this.trailPath.length=0,this.trailPath.push({x:e,y:t}),this.trailGraphics.clear(),this.trailGraphics.fillStyle(this.trailColor,1),this.trailGraphics.fillCircle(e,t,this.trailWidth/2)}updateTrail(e,t){const s=this.trailPath[this.trailPath.length-1],i=Phaser.Math.Distance.Between(s.x,s.y,e,t);if(i<this.interval)return;this.trailPath.push({x:e,y:t});const a=Math.ceil(i/(this.trailWidth*.6));for(let n=1;n<=a;n++){const o=n/a,r=Phaser.Math.Interpolation.Linear([s.x,e],o),h=Phaser.Math.Interpolation.Linear([s.y,t],o);this.trailGraphics.fillCircle(r,h,this.trailWidth/2);const l=this.getNearestHexagon(r,h);l&&l.texture?.key!=="my_hexagon"&&l.texture?.key!=="limit"&&this.drawHexBorder(l.x,l.y)}}finishTrail(){if(this.isDrawing=!1,this.trailPath.length<5){this.trailGraphics.clear(),this.trailPath.length=0;return}this.trailGraphics.clear();const e=this.trailPath.slice(),t=this.activeHexagon(e,!1);this.paintInsideAndBorder(e,t),this.trailPath.length=0,this.findInnerHoles(!0)}paintInsideAndBorder(e,t){const s=new Set,i=a=>{if(!a||a.texture?.key==="my_hexagon")return;const n=a.col!==void 0&&a.row!==void 0?`${a.col},${a.row}`:`${a.x},${a.y}`;s.has(n)||(s.add(n),this.markAsMyHexagon(a))};for(const a of t)i(a);for(const a of e){const n=this.getNearestHexagon(a.x,a.y);i(n)}}activeHexagon(e=this.trailPath,t=!0){if(!e||e.length<3||!Array.isArray(this.hexagonList))return[];const s=e.slice(),i=s[0],a=s[s.length-1];Phaser.Math.Distance.Between(i.x,i.y,a.x,a.y)>1&&s.push({x:i.x,y:i.y});const n=[];for(const m of s)n.push(m.x,m.y);const o=new Phaser.Geom.Polygon(n),r=Phaser.Geom.Rectangle.FromPoints(s.map(m=>new Phaser.Geom.Point(m.x,m.y))),h=[],l=Math.max(1,Math.min(this.hexagonSize.w,this.hexagonSize.h)*.35),c=8,d=(m,g)=>{if(Phaser.Geom.Polygon.Contains(o,m,g))return!0;for(let u=0;u<c;u++){const y=Math.PI*2*u/c,x=m+l*Math.cos(y),O=g+l*Math.sin(y);if(Phaser.Geom.Polygon.Contains(o,x,O))return!0}return!1};for(const m of this.hexagonList){const{x:g,y:u}=m;Phaser.Geom.Rectangle.Contains(r,g,u)&&d(g,u)&&h.push(m)}return t&&h.forEach(m=>this.markAsMyHexagon(m)),h}getNearestHexagon(e,t){let s=null,i=1/0;for(const a of this.hexagonList){const n=Phaser.Math.Distance.Between(e,t,a.x,a.y);n<i&&(i=n,s=a)}return s}getClosestWallToPoint(e){let t=null,s=1/0;const i=this.playerBoundsHexagon.points;for(let a=0;a<i.length;a++){const n=i[a],o=i[(a+1)%i.length],r=new Phaser.Geom.Line(n.x,n.y,o.x,o.y),h=new Phaser.Geom.Point;Phaser.Geom.Line.GetNearestPoint(r,e,h);const l=Phaser.Math.Distance.Between(e.x,e.y,h.x,h.y);l<s&&(s=l,t=r)}return t}gameOver(e="hit_trail"){this.isGameOver||(this.isGameOver=!0,this.physics.world.pause(),this.player.setVelocity(0,0),this.isDrawing=!1,this.spawnTimer?.remove(),this.tweens.add({targets:this.player,alpha:{from:1,to:.2},yoyo:!0,duration:100,repeat:4}),this.time.delayedCall(350,()=>{this.scene.pause(),this.scene.launch("GameOverScene",{reason:e})}))}cullEnemiesOnMyHex(){if(!this.enemies)return;const e=this.enemies.getChildren();for(let t=e.length-1;t>=0;t--){const s=e[t];!s||!s.active||this.isOnMyHexagon(s.x,s.y)&&this.fadeOutAndRemoveEnemy(s)}}fadeOutAndRemoveEnemy(e){e.pendingRemoval||(e.pendingRemoval=!0,this.tweens.killTweensOf(e),e.setVelocity?.(0,0),e.body&&(e.body.enable=!1),this.tweens.add({targets:e,alpha:{from:1,to:.2},yoyo:!0,duration:120,repeat:4,onComplete:()=>{this.tweens.killTweensOf(e),e.destroy()}}))}checkEnemiesHitTrail(){if(!this.enemies||!this.isDrawing)return;const e=this.trailPath.length;if(e<2)return!1;const t=this.enemies.getChildren();if(!t||t.length===0)return!1;for(let s=0;s<t.length;s++){const i=t[s];if(!i||!i.active||i.pendingRemoval)continue;const a=this.trailWidth*.5+this.enemyRadius;for(let n=0;n<e;n+=1){const o=this.trailPath[n],r=i.x-o.x,h=i.y-o.y;if(r*r+h*h<=a*a)return this.gameOver("enemy_hit_trail"),!0}}return!1}markAsMyHexagon(e){e&&(e.texture?.key==="my_hexagon"||e.texture?.key==="limit"||(e.setTexture("my_hexagon"),e.setDepth&&e.setDepth(1),this.stage&&typeof this.stage.updateQuizMask=="function"&&this.stage.updateQuizMask()))}}const A={fontSize:"60px",fontFamily:E},D={...A,color:"#fddc3e"},v={...A,color:"#ffffff"},N={...A,color:"#c4a5fd"},Y={hit_enemy:[{text:"꿀벌",style:D},{text:"이 ",style:v},{text:"적",style:N},{text:"과 부딪혔어요!",style:v}],hit_trail:[{text:"꿀벌",style:D},{text:"이 ",style:v},{text:"선",style:N},{text:"에 닿았어요!",style:v}],enemy_hit_trail:[{text:"적",style:D},{text:"이 ",style:v},{text:"선",style:N},{text:"에 닿았어요!",style:v}],default:[{text:"게임 오버!",style:v}]},V=[`아쉬워!
할 수 있었는데!`,`아까워!
실수한 거야!`,`아,
잘하고 있었는데!`,`다시 해보자!
할 수 있어!`,`괜찮아,
다시 하면 돼!`,`다음엔
꼭 성공한다!`,`조금 어렵지만
할 수 있어!`,`침착하게
다시 해보자!`,`포기 안 해!
다시 할거야!`,`이제 알겠어!
다시 도전!`,`감 잡았어!
이번엔 성공할거야!`,`앗! 아깝다~!
다시 도전!`,`실수할 수도 있지!
다시 하자!`];class _e extends Phaser.Scene{constructor(){super("GameOverScene")}init(e){this.reason=e.reason}create(){this.centerX=this.cameras.main.width/2,this.centerY=this.cameras.main.height/2,I(this,0,.7),this.createUI(),this.createText(),this.createButton()}initBackground(){const e=this.add.graphics();e.fillStyle(0,.7),e.fillRect(0,0,this.sys.game.config.width,this.sys.game.config.height)}createUI(){this.add.image(this.centerX-100,this.centerY-130,"bee_gameOver").setScale(.6667),this.add.image(this.centerX+150,this.centerY-150,"balloon_gameOver").setScale(.6667),this.add.image(this.centerX,this.centerY+90,"text_box").setScale(.6667)}createText(){this.createResonText(),this.createBalloonText()}createButton(){const e=this.add.image(this.centerX,this.centerY+245,"return_btn").setScale(.6667).setInteractive({useHandCursor:!0});e.on("pointerover",()=>e.setFrame(1)),e.on("pointerout",()=>e.setFrame(0)),e.on("pointerdown",()=>this.chageScene())}chageScene(){this.scene.stop("GameOverScene"),this.scene.start("StartScene")}createResonText(){const e=Y[this.reason]||Y.default,t=this.add.container(0,0);let s=0;for(const a of e){const n=this.add.text(0,0,a.text,a.style);n.setX(s),s+=n.width,t.add(n)}const i=t.getBounds();t.setPosition(this.centerX-i.width/2,this.centerY+50)}createBalloonText(){const e=Math.floor(Math.random()*V.length),t=V[e],s=this.add.container(0,0),i=this.add.text(0,0,t,{fontSize:"48px",fontFamily:E,color:"#000000",align:"center"}),a=i.getBounds();i.setPosition(-a.width/2,-a.height/2),s.add(i),s.setPosition(this.centerX+170,this.centerY-150)}}const _={WIDTH:300,HEIGHT:80,PADDING_Y:20,COLOR_PURPLE:9194654,COLOR_YELLOW:16636990},B=(p,e="48px")=>({fontFamily:E,fontStyle:"bold",padding:{top:5},color:p,fontSize:typeof e=="number"?`${e}px`:e}),T={PINK:B("#f471aa"),BLUE:B("#346f9e"),DIAMOND:B("#10c4c4"),GOLD:B("#ffd15b"),SILVER:B("#cbe5e8"),BRONZE:B("#ca6e59"),BROWN:B("#6d4a43","40px")},we={1:"다이아몬드",2:"금",3:"은",4:"동"},be={1:T.DIAMOND,2:T.GOLD,3:T.SILVER,4:T.BRONZE};class Pe extends Phaser.Scene{constructor(){super("QuizScene")}init(e){this.quiz=e.quiz,this.allQuizzes=e.allQuizzes,this.canvasSize=e.canvasSize,this.medalNumber=e.medalNumber}preload(){this.load.image(this.quiz.answer+"_full",this.quiz.fullImage)}create(){const e=document.querySelector("canvas");e.style.transition="opacity 0.2s",setTimeout(()=>{e.style.opacity="1",e.style.transition="",this.cameras.main.setBackgroundColor("#4a2e1d")},20),this.anims.exists("bee_incorrect_ani")||this.anims.create({key:"bee_incorrect_ani",frames:this.anims.generateFrameNumbers("bee_incorrect",{start:0,end:89}),frameRate:10,repeat:-1});for(let t=1;t<=4;t++)this.createMedalAnimation(t);this.add.text(this.scale.width/2,80,"그림이 나타내는 영어 단어는 무엇일까요?",{fontSize:"50px",color:"#ffffff",fontFamily:E}).setOrigin(.45),this.add.image(100,80,`medal_${this.medalNumber}`).setScale(1),this.textures.exists("worldSnapshot")&&(this.snapshotImage=this.renderMaskedImage("worldSnapshot")),this.renderAnswerButtons(),this.exitButton=this.renderFeedbackButton("exit_btn",()=>this.returnToPlayScene())}createHexMaskGraphics(e,t,s){const i=this.make.graphics({x:0,y:0,add:!1}),a=e+s/2+6,n=t+s/2,o=s/2;i.beginPath();for(let r=0;r<6;r++){const h=Phaser.Math.DegToRad(60*r-30),l=a+o*Math.cos(h),c=n+o*Math.sin(h);r===0?i.moveTo(l,c):i.lineTo(l,c)}return i.closePath(),i.fillPath(),i}renderMaskedImage(e,t=1,s=300,i=300){const{w:a}=this.canvasSize,n=a/2-s-100,o=i-s/4-2,r=this.add.image(a/4,i,e).setOrigin(0,0).setAlpha(t),{width:h,height:l}=r,c=s/(h>l?l:h);r.setScale(c).setPosition(n,o);const m=this.createHexMaskGraphics(n,o,s).createGeometryMask();return r.setMask(m),r}renderAnswerButtons(){const e=this.quiz.answer,t=Phaser.Utils.Array.Shuffle([...this.quiz.options]),s=this.canvasSize.w/2+150,i=220;this.itemButtonGroup=this.add.group(),t.forEach((a,n)=>{const o=s,r=i+n*(_.HEIGHT+_.PADDING_Y),h=this.createAnswerButton(o,r,a,()=>{this.itemButtonGroup.children.iterate(l=>l.disableInteractive&&l.disableInteractive()),this.exitButton&&this.exitButton.active&&this.exitButton.destroy(),a===e?this.correct():this.incorrect()});this.itemButtonGroup.add(h)})}getWideHexagonPoints(e,t){return[0,t/2,e*.1,0,e*.9,0,e,t/2,e*.9,t,e*.1,t]}createAnswerButton(e,t,s,i){const a=this.getWideHexagonPoints(_.WIDTH,_.HEIGHT),n=new Phaser.Geom.Polygon(a),o=this.add.graphics();o.fillStyle(_.COLOR_YELLOW),o.fillPoints(n.points,!0);const r=this.add.text(_.WIDTH/2,_.HEIGHT/2,s,{fontSize:"36px",fontFamily:E,color:`#${_.COLOR_PURPLE.toString(16)}`,fontStyle:"bold"}).setOrigin(.5),h=this.add.container(e,t,[o,r]);return h.setInteractive(n,Phaser.Geom.Polygon.Contains),h.on("pointerdown",i),h.on("pointerover",()=>{o.clear(),o.fillStyle(_.COLOR_PURPLE),o.lineStyle(4,_.COLOR_YELLOW),o.fillPoints(n.points,!0),o.strokePoints(n.points,!0),r.setColor(`#${_.COLOR_YELLOW.toString(16)}`),this.setCursor("pointer")}),h.on("pointerout",()=>{o.clear(),o.fillStyle(_.COLOR_YELLOW),o.fillPoints(n.points,!0),r.setColor(`#${_.COLOR_PURPLE.toString(16)}`),this.setCursor("default")}),h}renderFeedbackContent(e){let t=0,s=0;const i=10,a=20,n=e.map(l=>{if(l.type==="image"&&l.key==="bee_incorrect"){const c=128*l.scale+a,d=128*l.scale;return t+=c,{width:c,height:d}}else{const c=this.make.text({text:l.text,style:l.style},!1);return t+=c.width,c.height>s&&(s=c.height),{width:c.width,height:c.height}}});t+=i*(e.length-1);let o=(this.canvasSize.w-t)/2;const r=80,h=r+s/2;e.forEach((l,c)=>{l.type==="image"&&l.key==="bee_incorrect"?this.add.sprite(o+64*l.scale,r+20,"bee_incorrect").setScale(l.scale).setOrigin(.5,.5).play("bee_incorrect_ani"):this.add.text(o,h,l.text,l.style).setOrigin(0,1),o+=n[c].width+i})}setCursor(e="default"){this.input&&this.input.setDefaultCursor&&this.input.setDefaultCursor(e)}correct(){this.handleAnswerResult(!0)}incorrect(){this.handleAnswerResult(!1)}handleAnswerResult(e){this.setCursor("default"),this.sound.play(e?"correct":"incorrect"),e&&(this.increaseMedalCount(this.medalNumber),this.showFullAnswerImage(this.snapshotImage)),this.renderFeedbackBox(e);const t=e?"next_btn":"main_btn";this.renderFeedbackButton(t,()=>this.goToNextQuiz())}showFullAnswerImage(e){const{x:t,y:s,displayWidth:i,displayHeight:a,mask:n}=e;e.destroy();const o=this.add.image(t,s,"worldSnapshotNoHexagon").setAlpha(0).setOrigin(0,0),r=i/o.width,h=a/o.height,l=Math.min(r,h);o.setScale(l),o.setPosition(t,s),n&&o.setMask(n),this.tweens.add({targets:o,alpha:1,duration:1e3,ease:"Linear"})}goToNextQuiz(){this.sound.play("click"),this.scene.stop("PlayScene"),this.scene.stop("QuizScene");const e=this.allQuizzes.filter(t=>t.answer!==this.quiz.answer);e.length===0?this.scene.start("PlayScene",{quiz:this.quiz,allQuizzes:e,showMedalOnStart:!0,medalNumber:this.medalNumber}):this.scene.start("PlayScene",{allQuizzes:e,showMedalOnStart:!0,medalNumber:this.medalNumber})}returnToPlayScene(){this.scene.stop("QuizScene"),this.scene.resume("PlayScene")}renderFeedbackButton(e,t){const s=this.canvasSize.w-50,i=this.canvasSize.h-50,a=this.add.image(s,i,e).setOrigin(1,1).setInteractive({useHandCursor:!0}).setDepth(2);return a.on("pointerdown",()=>t()),a.on("pointerover",()=>a.setTexture(`${e}_h`)),a.on("pointerout",()=>a.setTexture(`${e}`)),a}buildFeedbackContent(e){return e?[{type:"text",text:"정답",style:T.PINK},{type:"text",text:"입니다! ",style:T.BROWN},{type:"text",text:`${we[this.medalNumber]}메달`,style:be[this.medalNumber]},{type:"text",text:"획득!",style:T.BROWN}]:[{type:"image",key:"bee_incorrect",scale:.6},{type:"text",text:"오답",style:T.BLUE},{type:"text",text:"입니다!",style:T.BROWN}]}renderFeedbackBox(e=!0){const t=this.buildFeedbackContent(e),s=100,i=80-s/2,a=`medal_${this.medalNumber}_ani`;if(this.add.graphics().fillStyle(16117466,1).fillRect(0,i,this.canvasSize.w,s),e){const n=this.add.sprite(this.canvasSize.w/2,this.canvasSize.h/2,`medal_${this.medalNumber}_1`).setOrigin(.5,.5).setDepth(2);this.add.graphics().fillStyle(0,.5).fillRect(0,0,this.canvasSize.w,this.canvasSize.h).setDepth(1),n.play(a)}this.renderFeedbackContent(t)}createMedalAnimation(e){const t=`medal_${e}_ani`;if(this.anims.exists(t))return;const s=[];for(let i=1;i<=5;i++)s.push(...this.anims.generateFrameNumbers(`medal_${e}_${i}`,{start:0,end:17}));this.anims.create({key:t,frames:s,frameRate:10,repeat:-1})}increaseMedalCount(e){let t=this.registry.get("myMedals")||{1:0,2:0,3:0,4:0};t[e]++,this.registry.set("myMedals",t)}}const X={fontSize:"40px",color:"#ffffff",fontStyle:"bold",fontFamily:E};class Se extends Phaser.Scene{constructor(){super("MedalScene")}init(e){this.remainingQuizzes=e.remainingQuizzes}create(){this.centerX=this.cameras.main.width/2,this.centerY=this.cameras.main.height/2,I(this,0,.7),this.createButton(),this.createUI(),this.initBgm()}initBgm(){M.isOn?M.play():M.stop()}createButton(){const e=this.remainingQuizzes?.length>0?"start_btn":"reset_btn";this.actionButton=this.add.image(this.centerX,660,e).setScale(.6667).setInteractive({useHandCursor:!0}),this.homeButton=this.add.image(50,50,"home_btn").setOrigin(0,0).setInteractive({useHandCursor:!0}),this.homeButton.on("pointerdown",()=>{this.sound.play("click"),this.scene.start("StartScene")}),this.actionButton.on("pointerdown",()=>{this.sound.play("click"),this.changeScene()}),C(this.actionButton,`${e}`),this.createBgmButton()}changeScene(){this.remainingQuizzes?.length>0?(this.scene.stop("MedalScene"),this.scene.resume("PlayScene")):(this.scene.stop("PlayScene"),this.scene.stop("MedalScene"),this.scene.start("StartScene"))}createUI(){this.add.image(250,this.centerY+15,"bee_medal"),this.medalUI=this.createMedalBox().setPosition(this.centerX-150,this.centerY-40)}createMedalBox(){const e=this.remainingQuizzes?.length>0?"숨겨진 그림의 정체를 밝혀내라!":"숨겨진 그림의 정체를 모두 밝혔다!",t=this.registry.get("myMedals")||{1:0,2:0,3:0,4:0},s=this.add.container(0,0),i=700,a=180,n=this.add.text(i/2,-60,e,X).setOrigin(.5),o=this.add.graphics();o.lineStyle(4,16636990,1),o.fillStyle(0,.5),o.strokeRoundedRect(0,0,i,a,15),o.fillRoundedRect(0,0,i,a,15);const r=[o,n],h=["medal_1","medal_2","medal_3","medal_4"],l=i/h.length;return h.forEach((c,d)=>{const m=l*(d+.5),g=70,u=this.add.image(m,g,c).setScale(1.2),y=this.add.text(m,g+70,`${t[d+1]}`,X).setOrigin(.5);r.push(u,y)}),s.add(r),s}createBgmButton(){this.bgmBtn=this.add.image(1140,610,"bgm_O").setInteractive({useHandCursor:!0}).setScrollFactor(0),this.updateBgmButtonTexture(!M.isOn),this.bgmBtn.on("pointerdown",()=>{M.toggle(),this.updateBgmButtonTexture(!M.isOn),this.sound.play("click")})}updateBgmButtonTexture(e){this.bgmBtn.setTexture(e?"bgm_X":"bgm_O")}}const Te={type:Phaser.WEBGL,width:1280,height:720,parent:"gameContainer",backgroundColor:"0xc9effa",scene:[Q,$,Z,re,xe,_e,Pe,Se],physics:{default:"arcade",arcade:{debug:!1}},scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH}};new Phaser.Game(Te)})();
